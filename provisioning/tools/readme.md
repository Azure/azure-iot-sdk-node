# Tools for the Azure IoT Device Provisioning Device SDK for Node.js

This directory contains tools that may be useful while working with the Azure IoT Device Provisioning Device SDK for Node.js

## WARNING AND DISCLAIMER

**Certs generated by this script are not for production.  They are not guaranteed to be secure in any way, shape, or form.**

**This script is only to help you understand the Azure IoT Device Provisioning Device SDK for Node.js**

**Use your official, secure mechanisms for this cert generation.**

## setup

Before running these tools, run `npm install` in this directory.

You also need to have [OpenSSL][lnk-openssl] installed and in your path.  Under Linux, you can probably use `apt install openssl` to install it.  Under Windows, you may need to build it yourself or find a [binary distribution][lnk-openssl-binaries].

## create_test_cert.js

This tool can be used to create test X509 certificates that can be used with individual and group enrollments.  You can invoke it by calling `node create_test_cert.js` and passing in the appropriate commands.

This tool will produce 3 files:

filename | contents
-------- | --------
\<name\>_cert.pem | The public portion of the X509 certificate
\<name\>_key.pem | The private key for the X509 certificate
\<name\>_fullchain.pem | The entire keychain for the X509 certificate.

In many cases, the full chain is more useful than the individual cert.  This file is necessary, for instance, when creating a group using an intermediate CA that is unkonwn to the DPS service.

Note: In some cases, such as root and self-signed device certs, the tool will produce a _fullchain file which is identical to the cert itself.

Note #2: The tool will likely create a chain which is longer than necessary.  For exammple, if the root certificate has been verified in the provisioning service, it doesn't need to be included in the chain.  Likewise, if any intermediate CA certs have been verifited, they don't need to be included and none of their parent certs need to be included.

Note #3: The tool with produce private keys in the `.key.pem` and `.pfx` format. Note PFX is protected with a test password `1234` you must consider changing before distributing the pfx file.

```
F:\repos\node\provisioning\tools>node create_test_cert.js
create_test_cert.js <command>

Commands:
  create_test_cert.js root [commonName]                                                                                create a root certificate
  create_test_cert.js intermediate <commonName> <parentCommonName>                                                     create an intermediate cert
  create_test_cert.js device <commonName> [parentCommonName]                                                           create a device cert
  create_test_cert.js verification [--ca root cert pem file name] [--key root cert key pem file name] [--nonce nonce]  provide proof of possession for a cert using a verification code

### create a root certificate
Creating a test root certificate is as simple as calling this script with the "root" command and passing in a common name for the certificate.  If no common name is provided, it will use "Test Root Cert" as the common name.

```
F:\repos\node\provisioning\tools>node create_test_cert.js root "My Test Root Certificate"
creating certificate with common name=My Test Root Certificate
saving cert to myTestRootCertificate_cert.pem.
saving key to myTestRootCertificate_key.pem.
saving cert with chain to myTestRootCertificate_fullchain.pem.
```


### create an intermediate cert
To create a test intermediate CA, you need to pass the "intermediate" command along with a common name and the common name of the parent cert.  The parent cert can either be a root cert or another intermediate cert.  These certs can be chained.

```
F:\repos\node\provisioning\tools>node create_test_cert.js root "Intermediate CA 1" "My Test Root Certificate"
creating certificate with common name=Intermediate CA 1
saving cert to intermediateCa1_cert.pem.
saving key to intermediateCa1_key.pem.
saving cert with chain to intermediateCa1_fullchain.pem.

F:\repos\node\provisioning\tools>node create_test_cert.js root "Intermediate CA 1" "Intermediate CA 2"
creating certificate with common name=Intermediate CA 1
saving cert to intermediateCa1_cert.pem.
saving key to intermediateCa1_key.pem.
saving cert with chain to intermediateCa1_fullchain.pem.
```

### create a device cert (from a CA cert)
To create a test device cert based on a CA cert, you need to pass the "device" command along with the common name of your device and the common name of the parent certificate.

```
F:\repos\node\provisioning\tools>node create_test_cert.js device "Device 42" "Intermediate CA 2"
creating certificate with common name=Device 42
saving cert to device42_cert.pem.
saving key to device42_key.pem.
saving cert with chain to device42_fullchain.pem.
```

### create a device cert (self-signed)
To create a test self signed device certificate, you need to pass the "device" command along with the common name of your device, and without the name of a parent certificate.

```
F:\repos\node\provisioning\tools>node create_test_cert.js device "Device 43"
creating certificate with common name=Device 43
saving cert to device43_cert.pem.
saving key to device43_key.pem.
saving cert with chain to device43_fullchain.pem.
```

### provide proof of possession for a cert using a verification code
To verify a cert, you need to pass the "verification" command along with the cert filename, the key filename, and the verification code from the Azure portal.  The tool will then create a new certificate (`verification_cert.pem`) which can be uploaded back to the portal to provide proof of possession.

```
F:\repos\node\provisioning\tools>node create_test_cert.js verification --ca foo_cert.pem --key foo_key.pem --nonce AAEC1DA657F1B63F440BCB58DFE5E3E274B6162D2B2FA6CD
creating certificate with common name=AAEC1DA657F1B63F440BCB58DFE5E3E274B6162D2B2FA6CD
saving cert to verification_cert.pem.
saving key to verification_key.pem.
saving cert with chain to verification_fullchain.pem.
```

[lnk-openssl]: https://www.openssl.org/community/binaries.html
[lnk-openssl-binaries]: https://www.openssl.org/community/binaries.html